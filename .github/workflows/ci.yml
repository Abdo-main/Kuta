name: Kuta CI/CD

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  release:
    types: [published]

env:
  BUILD_TYPE: Release
  VULKAN_SDK_VERSION: "1.4.321.1"

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache vcpkg
        id: cache-vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/vcpkg
            !${{ github.workspace }}/vcpkg/buildtrees
            !${{ github.workspace }}/vcpkg/packages
            !${{ github.workspace }}/vcpkg/downloads
          key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Setup vcpkg
        if: steps.cache-vcpkg.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg
          .\bootstrap-vcpkg.bat

      - name: Bootstrap vcpkg if needed
        if: steps.cache-vcpkg.outputs.cache-hit == 'true'
        shell: powershell
        run: |
          cd vcpkg
          if (-Not (Test-Path "vcpkg.exe")) {
            .\bootstrap-vcpkg.bat
          }

      - name: Cache Vulkan SDK
        id: cache-vulkan-sdk
        uses: actions/cache@v4
        with:
          path: C:/VulkanSDK
          key: vulkan-sdk-windows-${{ env.VULKAN_SDK_VERSION }}

      - name: Download Vulkan SDK
        if: steps.cache-vulkan-sdk.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          $url = "https://sdk.lunarg.com/sdk/download/$env:VULKAN_SDK_VERSION/windows/vulkansdk-windows-X64-$env:VULKAN_SDK_VERSION.exe"
          Write-Host "Downloading Vulkan SDK from $url"
          Invoke-WebRequest -Uri $url -OutFile vulkansdk-installer.exe
          Write-Host "Installing Vulkan SDK..."
          Start-Process -FilePath vulkansdk-installer.exe -ArgumentList '--accept-licenses --default-answer --confirm-command install' -Wait -NoNewWindow
          Write-Host "Vulkan SDK installed"

      - name: Setup Vulkan environment
        shell: powershell
        run: |
          $vulkanPath = "C:/VulkanSDK/$env:VULKAN_SDK_VERSION"
          Add-Content -Path $env:GITHUB_ENV -Value "VULKAN_SDK=$vulkanPath"
          Add-Content -Path $env:GITHUB_PATH -Value "$vulkanPath/Bin"
          Write-Host "Vulkan SDK path: $vulkanPath"

      - name: Configure CMake
        shell: powershell
        run: |
          $toolchainFile = "${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake"
          Write-Host "Configuring CMake with toolchain: $toolchainFile"
          cmake -B build -S . `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="$toolchainFile" `
            -G "Visual Studio 17 2022" -A x64
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "CMake configuration failed"
            exit 1
          }

      - name: Build Kuta Library
        shell: powershell
        run: |
          Write-Host "Building Kuta library..."
          cmake --build build --config Release --parallel
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Build failed"
            exit 1
          }

      - name: Verify build output
        shell: powershell
        run: |
          Write-Host "Searching for build output..."
          Get-ChildItem -Path build -Recurse -Include *.dll,*.lib | ForEach-Object { 
            Write-Host "Found: $($_.FullName)" 
          }
          
          $dllPath = $null
          if (Test-Path "build/Release/kuta.dll") { 
            $dllPath = "build/Release" 
          } elseif (Test-Path "build/Debug/kuta.dll") { 
            $dllPath = "build/Debug" 
          } elseif (Test-Path "build/kuta.dll") { 
            $dllPath = "build" 
          }
          
          if ($dllPath) {
            Write-Host "Success: kuta.dll found in $dllPath"
            Add-Content -Path $env:GITHUB_ENV -Value "DLL_PATH=$dllPath"
          } else {
            Write-Host "ERROR: kuta.dll not found!"
            Write-Host "Build directory structure:"
            Get-ChildItem -Path build -Recurse | Select-Object FullName | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }

      - name: Copy dependencies
        shell: powershell
        run: |
          $dllPath = $env:DLL_PATH
          Write-Host "Copying dependencies to $dllPath"
          
          # Copy Vulkan DLL
          $vulkanDll = "C:/VulkanSDK/$env:VULKAN_SDK_VERSION/Bin/vulkan-1.dll"
          if (Test-Path $vulkanDll) {
            Copy-Item $vulkanDll -Destination "$dllPath/" -Force
            Write-Host "Copied Vulkan DLL"
          }
          
          # Copy vcpkg DLLs
          $vcpkgBin = "${{ github.workspace }}/vcpkg/installed/x64-windows/bin"
          if (Test-Path $vcpkgBin) {
            Get-ChildItem $vcpkgBin -Filter *.dll | ForEach-Object {
              Copy-Item $_.FullName -Destination "$dllPath/" -Force
              Write-Host "Copied: $($_.Name)"
            }
          }

      - name: Package artifacts
        shell: powershell
        run: |
          $dllPath = $env:DLL_PATH
          
          # Create artifact directory
          New-Item -ItemType Directory -Force -Path "artifacts/library" | Out-Null
          New-Item -ItemType Directory -Force -Path "artifacts/example/include" | Out-Null
          
          # Copy library files
          Copy-Item "$dllPath/kuta.dll" -Destination "artifacts/library/" -Force
          if (Test-Path "$dllPath/kuta.lib") {
            Copy-Item "$dllPath/kuta.lib" -Destination "artifacts/library/" -Force
          }
          Copy-Item "include/*.h" -Destination "artifacts/library/" -Force
          
          # Copy for example
          Copy-Item "$dllPath/kuta.dll" -Destination "artifacts/example/include/" -Force
          if (Test-Path "$dllPath/kuta.lib") {
            Copy-Item "$dllPath/kuta.lib" -Destination "artifacts/example/include/" -Force
          }
          Copy-Item "include/*.h" -Destination "artifacts/example/include/" -Force
          
          # Copy all DLLs
          Get-ChildItem "$dllPath" -Filter *.dll | ForEach-Object {
            Copy-Item $_.FullName -Destination "artifacts/example/" -Force
          }
          
          Write-Host "Artifacts packaged successfully"

      - name: Upload Library Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kuta-library-windows-x64
          path: artifacts/library/
          retention-days: 30

      - name: Upload Example Dependencies
        uses: actions/upload-artifact@v4
        with:
          name: kuta-example-deps-windows-x64
          path: artifacts/example/
          retention-days: 30

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libvulkan-dev \
            vulkan-tools \
            libglfw3-dev \
            libcglm-dev \
            libassimp-dev

      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=$BUILD_TYPE

      - name: Build Kuta Library
        run: |
          cmake --build build --parallel
          echo "Build completed"

      - name: Verify build output
        run: |
          ls -lah build/
          if [ -f "build/libkuta.so" ]; then
            echo "✓ libkuta.so found"
            file build/libkuta.so
          else
            echo "✗ libkuta.so not found!"
            find build -name "*.so" -o -name "*.a"
            exit 1
          fi

      - name: Package artifacts
        run: |
          mkdir -p artifacts/library
          cp build/libkuta.so artifacts/library/
          cp include/*.h artifacts/library/
          echo "Linux library packaged"

      - name: Upload Linux Library Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kuta-library-linux-x64
          path: artifacts/library/
          retention-days: 30

  release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release archives
        run: |
          cd artifacts
          
          # Windows library
          if [ -d "kuta-library-windows-x64" ]; then
            cd kuta-library-windows-x64
            zip -r ../../kuta-library-windows-x64.zip .
            cd ..
          fi
          
          # Windows example dependencies
          if [ -d "kuta-example-deps-windows-x64" ]; then
            cd kuta-example-deps-windows-x64
            zip -r ../../kuta-example-deps-windows-x64.zip .
            cd ..
          fi
          
          # Linux library
          if [ -d "kuta-library-linux-x64" ]; then
            cd kuta-library-linux-x64
            tar czf ../../kuta-library-linux-x64.tar.gz .
            cd ..
          fi
          
          cd ..
          echo "Release archives created:"
          ls -lh *.zip *.tar.gz 2>/dev/null || echo "No archives found"

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            kuta-library-windows-x64.zip
            kuta-example-deps-windows-x64.zip
            kuta-library-linux-x64.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
