name: Kuta CI/CD

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  release:
    types: [published]

env:
  BUILD_TYPE: Release
  VULKAN_SDK_VERSION: "1.4.321.1"

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: "a42af01b72c28a8e1d7b48107b33e4f286a55ef6"

      - name: Cache Vulkan SDK
        id: cache-vulkan-sdk
        uses: actions/cache@v4
        with:
          path: C:/VulkanSDK
          key: vulkan-sdk-windows-${{ env.VULKAN_SDK_VERSION }}

      - name: Download Vulkan SDK
        if: steps.cache-vulkan-sdk.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          $url = "https://sdk.lunarg.com/sdk/download/$env:VULKAN_SDK_VERSION/windows/vulkansdk-windows-X64-$env:VULKAN_SDK_VERSION.exe"
          Invoke-WebRequest -Uri $url -OutFile vulkansdk-windows-X64.exe
          Start-Process -FilePath vulkansdk-windows-X64.exe -ArgumentList '--accept-licenses --default-answer --confirm-command install' -Wait

      - name: Setup Vulkan environment
        shell: powershell
        run: |
          echo "VULKAN_SDK=C:/VulkanSDK/$env:VULKAN_SDK_VERSION" >> $env:GITHUB_ENV
          echo "C:/VulkanSDK/$env:VULKAN_SDK_VERSION/Bin" >> $env:GITHUB_PATH

      - name: Install dependencies via vcpkg
        run: |
          vcpkg install glfw3 cglm assimp --triplet x64-windows

      - name: Configure CMake
        run: |
          cmake -B build -S . -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE `
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake

      - name: Build Kuta
        run: cmake --build build --config $env:BUILD_TYPE --parallel

      - name: Copy Vulkan DLL
        shell: powershell
        run: |
          Copy-Item "C:/VulkanSDK/$env:VULKAN_SDK_VERSION/Bin/vulkan-1.dll" -Destination "build/Release/"

      - name: Copy assets to build directory
        shell: powershell
        run: |
          if (Test-Path "examples/models") {
            Copy-Item -Recurse "examples/models" -Destination "build/Release/"
            Write-Host "Copied models"
          }
          if (Test-Path "examples/textures") {
            Copy-Item -Recurse "examples/textures" -Destination "build/Release/"
            Write-Host "Copied textures"
          }
          if (Test-Path "examples/shaders") {
            Copy-Item -Recurse "examples/shaders" -Destination "build/Release/"
            Write-Host "Copied shaders"
          }

      - name: Verify build output
        shell: powershell
        run: |
          Write-Host "Build directory contents:"
          Get-ChildItem -Path build/Release/

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kuta-windows-x64
          path: |
            build/Release/kuta.exe
            build/Release/*.dll
            build/Release/*.spv
            build/Release/models/
            build/Release/textures/
            build/Release/shaders/
          retention-days: 30

  release:
    needs: [build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create release archive
        run: |
          cd kuta-windows-x64
          zip -r ../kuta-windows-x64.zip .
          cd ..
          echo "Windows archive contents:"
          unzip -l kuta-windows-x64.zip

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: kuta-windows-x64.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
