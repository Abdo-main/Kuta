name: Kuta CI/CD

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  release:
    types: [published]

env:
  BUILD_TYPE: Release
  VULKAN_SDK_VERSION: "1.4.321.1"

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libglfw3-dev \
            libvulkan-dev \
            vulkan-tools \
            spirv-tools \
            mesa-vulkan-drivers \
            vulkan-validationlayers \
            libcglm-dev \
            libassimp-dev \
            xvfb

      - name: Setup Vulkan SDK
        run: |
          # Use modern apt keyring method
          wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo tee /etc/apt/trusted.gpg.d/lunarg.asc
          sudo chmod 644 /etc/apt/trusted.gpg.d/lunarg.asc
          echo "deb https://packages.lunarg.com/vulkan/1.3.261 jammy main" | sudo tee /etc/apt/sources.list.d/lunarg-vulkan.list
          sudo apt update
          # Install only essential Vulkan SDK components (avoid problematic packages)
          sudo apt install vulkan-tools glslang-tools spirv-tools

      - name: Configure CMake
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=$BUILD_TYPE

      - name: Build Kuta
        run: cmake --build build --config $BUILD_TYPE --parallel $(nproc)

      - name: Verify shaders copied
        run: |
          echo "Checking for shader files..."
          ls -la build/*.spv || echo "No .spv files found in build directory"
          ls -la shaders/ || echo "No shaders directory found"

      - name: Test executable
        run: |
          export VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/lvp_icd.x86_64.json
          export VK_LAYER_PATH=/usr/share/vulkan/explicit_layer.d
          # Test that binary exists and can show help/version
          file build/kuta
          echo "Binary built successfully"

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kuta-linux-x64
          path: |
            build/kuta
            build/*.spv
          retention-days: 30

  build-windows-mingw:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MinGW
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-glfw
            mingw-w64-x86_64-vulkan-headers
            mingw-w64-x86_64-vulkan-loader
            mingw-w64-x86_64-cglm
            mingw-w64-x86_64-assimp

      - name: Cache Vulkan SDK
        id: cache-vulkan-sdk
        uses: actions/cache@v4
        with:
          path: C:/VulkanSDK
          key: vulkan-sdk-windows-${{ env.VULKAN_SDK_VERSION }}

      - name: Download Vulkan SDK
        if: steps.cache-vulkan-sdk.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          $url = "https://sdk.lunarg.com/sdk/download/$env:VULKAN_SDK_VERSION/windows/vulkansdk-windows-X64-$env:VULKAN_SDK_VERSION.exe"
          Invoke-WebRequest -Uri $url -OutFile VulkanSDK-Installer.exe
          Start-Process -FilePath VulkanSDK-Installer.exe -ArgumentList '--accept-licenses --default-answer --confirm-command install' -Wait

      - name: Build with MinGW (MSYS2)
        shell: msys2 {0}
        run: |
          export VULKAN_SDK="/c/VulkanSDK/$VULKAN_SDK_VERSION"
          mkdir -p build-mingw
          cd build-mingw
          cmake .. -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_MAKE_PROGRAM=mingw32-make
          mingw32-make -j$(nproc)

      - name: Copy required DLLs to build directory
        shell: msys2 {0}
        run: |
          echo "Copying required DLLs..."
          cd build-mingw

          # Copy MinGW runtime DLLs
          cp /mingw64/bin/libgcc_s_seh-1.dll .
          cp /mingw64/bin/libstdc++-6.dll .
          cp /mingw64/bin/libwinpthread-1.dll .

          # Copy GLFW DLL
          cp /mingw64/bin/libglfw-3.dll . 2>/dev/null || echo "libglfw-3.dll not found, might be static"

          # Copy Vulkan loader
          cp /mingw64/bin/libvulkan-1.dll .

          # Copy assimp DLL
          cp /mingw64/bin/libassimp-5.dll . 2>/dev/null || cp /mingw64/bin/libassimp.dll . 2>/dev/null || echo "assimp DLL not found"

          # Copy cglm DLL (if dynamic)
          cp /mingw64/bin/libcglm-0.dll . 2>/dev/null || echo "cglm might be static"

          # Copy any other potential dependencies using ldd
          for dll in $(ldd kuta.exe | grep -i mingw64 | awk '{print $3}'); do
            if [ -f "$dll" ]; then
              cp "$dll" .
              echo "Copied dependency: $(basename "$dll")"
            fi
          done

      - name: Test executable on Windows
        shell: cmd
        run: |
          cd build-mingw
          echo "Testing if executable runs..."
          kuta.exe --help || kuta.exe --version || echo "Executable test completed (may have exited normally)"

      - name: Verify build output
        shell: msys2 {0}
        run: |
          echo "Checking build results..."
          ls -la build-mingw/
          file build-mingw/kuta.exe
          echo "DLLs available:"
          ls -la build-mingw/*.dll || echo "No DLLs found"

      - name: Upload Windows MinGW artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kuta-windows-mingw-x64
          path: |
            build-mingw/kuta.exe
            build-mingw/*.spv
            build-mingw/*.dll
          retention-days: 30

  build-windows-msvc:
    runs-on: windows-latest
    if: false # Disabled for now, but keeping the structure

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

  release:
    needs: [build-linux, build-windows-mingw]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create release archives
        run: |
          # Create Linux archive
          mkdir -p kuta-linux-x64-package
          cp kuta-linux-x64/* kuta-linux-x64-package/
          tar -czf kuta-linux-x64.tar.gz -C kuta-linux-x64-package .

          # Create Windows MinGW archive
          mkdir -p kuta-windows-mingw-x64-package
          cp kuta-windows-mingw-x64/* kuta-windows-mingw-x64-package/
          zip -r kuta-windows-mingw-x64.zip kuta-windows-mingw-x64-package/

          echo "Archive contents:"
          echo "Linux:"
          tar -tzf kuta-linux-x64.tar.gz
          echo "Windows:"
          unzip -l kuta-windows-mingw-x64.zip

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            kuta-linux-x64.tar.gz
            kuta-windows-mingw-x64.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
