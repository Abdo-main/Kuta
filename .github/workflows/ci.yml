name: Kuta CI/CD

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  release:
    types: [published]

env:
  BUILD_TYPE: Release
  VULKAN_SDK_VERSION: "1.4.321.1"

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/vcpkg
            !${{ github.workspace }}/vcpkg/buildtrees
            !${{ github.workspace }}/vcpkg/packages
            !${{ github.workspace }}/vcpkg/downloads
          key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Setup vcpkg
        shell: powershell
        run: |
          if (-Not (Test-Path "vcpkg")) {
            git clone https://github.com/microsoft/vcpkg.git
            cd vcpkg
            .\bootstrap-vcpkg.bat
          } else {
            Write-Host "vcpkg already exists (from cache)"
            cd vcpkg
            if (-Not (Test-Path "vcpkg.exe")) {
              .\bootstrap-vcpkg.bat
            }
          }

      - name: Cache Vulkan SDK
        id: cache-vulkan-sdk
        uses: actions/cache@v4
        with:
          path: C:/VulkanSDK
          key: vulkan-sdk-windows-${{ env.VULKAN_SDK_VERSION }}

      - name: Download Vulkan SDK
        if: steps.cache-vulkan-sdk.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          $url = "https://sdk.lunarg.com/sdk/download/$env:VULKAN_SDK_VERSION/windows/vulkansdk-windows-X64-$env:VULKAN_SDK_VERSION.exe"
          Invoke-WebRequest -Uri $url -OutFile vulkansdk-windows-X64.exe
          Start-Process -FilePath vulkansdk-windows-X64.exe -ArgumentList '--accept-licenses --default-answer --confirm-command install' -Wait

      - name: Setup Vulkan environment
        shell: powershell
        run: |
          echo "VULKAN_SDK=C:/VulkanSDK/$env:VULKAN_SDK_VERSION" >> $env:GITHUB_ENV
          echo "C:/VulkanSDK/$env:VULKAN_SDK_VERSION/Bin" >> $env:GITHUB_PATH

      - name: Install dependencies via vcpkg (using manifest)
        shell: powershell
        run: |
          Write-Host "vcpkg will install dependencies from vcpkg.json during CMake configure"

      - name: Configure CMake
        shell: powershell
        run: |
          cmake -B build -S . `
            -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE `
            -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
            -G "Visual Studio 17 2022" -A x64

      - name: Build Kuta (Shared Library)
        run: cmake --build build --config $env:BUILD_TYPE --parallel

      - name: Verify build output
        shell: powershell
        run: |
          Write-Host "Build directory contents:"
          Get-ChildItem -Path build -Recurse -Include *.dll,*.lib | ForEach-Object { Write-Host $_.FullName }
          
          # Visual Studio puts output in build/Release/ or build/Debug/
          $dllPath = if (Test-Path "build/Release/kuta.dll") { 
            "build/Release" 
          } elseif (Test-Path "build/Debug/kuta.dll") { 
            "build/Debug" 
          } elseif (Test-Path "build/kuta.dll") { 
            "build" 
          } else { 
            $null 
          }
          
          if ($dllPath) {
            Write-Host "✓ kuta.dll found in: $dllPath"
            echo "DLL_PATH=$dllPath" >> $env:GITHUB_ENV
          } else {
            Write-Host "Build directory structure:"
            Get-ChildItem -Path build -Recurse | Select-Object FullName
            Write-Error "✗ kuta.dll not found!"
            exit 1
          }

      - name: Copy Vulkan DLL
        shell: powershell
        run: |
          Copy-Item "C:/VulkanSDK/$env:VULKAN_SDK_VERSION/Bin/vulkan-1.dll" -Destination "build/Release/" -ErrorAction SilentlyContinue

      - name: Copy vcpkg DLLs
        shell: powershell
        run: |
          # Copy all required DLLs from vcpkg
          $vcpkgBin = "${{ github.workspace }}/vcpkg/installed/x64-windows/bin"
          if (Test-Path $vcpkgBin) {
            Get-ChildItem $vcpkgBin -Filter *.dll | Copy-Item -Destination "build/Release/" -Force
            Write-Host "Copied vcpkg DLLs"
          }

      - name: Build example (lightDiffuse)
        shell: powershell
        run: |
          # Copy library and headers to example directory
          New-Item -ItemType Directory -Force -Path "examples/lightDiffuse/include"
          Copy-Item "build/Release/kuta.dll" -Destination "examples/lightDiffuse/include/"
          Copy-Item "build/Release/kuta.lib" -Destination "examples/lightDiffuse/include/" -ErrorAction SilentlyContinue
          Copy-Item -Recurse "include/*" -Destination "examples/lightDiffuse/include/" -Force

          # Compile example with MSVC
          cd examples/lightDiffuse
          cl.exe /std:c17 /I./include main.c /Fe:lightDiffuse.exe /link /LIBPATH:./include kuta.lib

          if ($LASTEXITCODE -eq 0) {
            Write-Host "✓ Example built successfully"
          }

      - name: Copy assets to example
        shell: powershell
        run: |
          cd examples/lightDiffuse
          if (Test-Path "assets") {
            Write-Host "Assets already in place"
          }

      - name: Upload Windows artifacts (Library)
        uses: actions/upload-artifact@v4
        with:
          name: kuta-library-windows-x64
          path: |
            build/Release/kuta.dll
            build/Release/kuta.lib
            include/*.h
          retention-days: 30

      - name: Upload Windows artifacts (Example)
        uses: actions/upload-artifact@v4
        with:
          name: kuta-example-windows-x64
          path: |
            examples/lightDiffuse/lightDiffuse.exe
            examples/lightDiffuse/include/kuta.dll
            examples/lightDiffuse/assets/
            build/Release/*.dll
          retention-days: 30

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libvulkan-dev \
            vulkan-tools \
            libglfw3-dev \
            libcglm-dev \
            libassimp-dev

      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=$BUILD_TYPE

      - name: Build Kuta (Shared Library)
        run: |
          cmake --build build --parallel

      - name: Verify build output
        run: |
          ls -lah build/
          if [ -f "build/libkuta.so" ]; then
            echo "✓ libkuta.so found"
          else
            echo "✗ libkuta.so not found!"
            exit 1
          fi

      - name: Build example (lightDiffuse)
        run: |
          cd examples/lightDiffuse
          if [ -f "Makefile" ]; then
            make
            echo "✓ Example built successfully"
          fi

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kuta-library-linux-x64
          path: |
            build/libkuta.so
            include/*.h
          retention-days: 30

  release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create release archives
        run: |
          # Windows library
          cd kuta-library-windows-x64
          zip -r ../kuta-library-windows-x64.zip .
          cd ..

          # Windows example
          cd kuta-example-windows-x64
          zip -r ../kuta-example-windows-x64.zip .
          cd ..

          # Linux library
          cd kuta-library-linux-x64
          tar czf ../kuta-library-linux-x64.tar.gz .
          cd ..

          echo "Archive contents:"
          ls -lh *.zip *.tar.gz

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            kuta-library-windows-x64.zip
            kuta-example-windows-x64.zip
            kuta-library-linux-x64.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
